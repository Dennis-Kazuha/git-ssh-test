#!/bin/bash

# åŠ å¯†è²¨å¹£ç›£æ§ç³»çµ± - å¿«é€Ÿå•Ÿå‹•è…³æœ¬

set -e

# é¡è‰²å®šç¾©
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# å°ˆæ¡ˆæ ¹ç›®éŒ„
PROJECT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# æ—¥èªŒå‡½æ•¸
log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# æª¢æŸ¥ Python
check_python() {
    if ! command -v python3 &> /dev/null; then
        log_error "Python3 æœªå®‰è£"
        exit 1
    fi
    log_success "Python3 å·²å®‰è£: $(python3 --version)"
}

# æª¢æŸ¥ PostgreSQL
check_postgresql() {
    if ! command -v psql &> /dev/null; then
        log_warning "PostgreSQL æœªå®‰è£ï¼Œè«‹å…ˆå®‰è£ï¼š"
        echo "  Ubuntu/Debian: sudo apt install postgresql"
        echo "  macOS: brew install postgresql"
        exit 1
    fi
    log_success "PostgreSQL å·²å®‰è£"
}

# å®‰è£ Python å¥—ä»¶
install_packages() {
    log_info "å®‰è£ Python å¥—ä»¶..."
    python3 -m pip install ccxt psycopg2-binary fastapi uvicorn --break-system-packages --quiet
    log_success "Python å¥—ä»¶å®‰è£å®Œæˆ"
}

# åˆå§‹åŒ–è³‡æ–™åº«
init_database() {
    log_info "åˆå§‹åŒ–è³‡æ–™åº«..."
    cd "$PROJECT_DIR"
    python3 database/db_init.py init
    log_success "è³‡æ–™åº«åˆå§‹åŒ–å®Œæˆ"
}

# å•Ÿå‹•æ•¸æ“šæ”¶é›†å™¨
start_collector() {
    log_info "å•Ÿå‹•æ•¸æ“šæ”¶é›†å™¨..."
    cd "$PROJECT_DIR"
    python3 collectors/main_collector.py &
    COLLECTOR_PID=$!
    echo $COLLECTOR_PID > /tmp/crypto_collector.pid
    log_success "æ•¸æ“šæ”¶é›†å™¨å·²å•Ÿå‹• (PID: $COLLECTOR_PID)"
}

# å•Ÿå‹• API ä¼ºæœå™¨
start_api() {
    log_info "å•Ÿå‹• API ä¼ºæœå™¨..."
    cd "$PROJECT_DIR/frontend"
    python3 api_server.py &
    API_PID=$!
    echo $API_PID > /tmp/crypto_api.pid
    log_success "API ä¼ºæœå™¨å·²å•Ÿå‹• (PID: $API_PID)"
}

# åœæ­¢æ‰€æœ‰æœå‹™
stop_services() {
    log_info "åœæ­¢æ‰€æœ‰æœå‹™..."
    
    if [ -f /tmp/crypto_collector.pid ]; then
        COLLECTOR_PID=$(cat /tmp/crypto_collector.pid)
        if ps -p $COLLECTOR_PID > /dev/null 2>&1; then
            kill $COLLECTOR_PID
            log_success "æ•¸æ“šæ”¶é›†å™¨å·²åœæ­¢"
        fi
        rm /tmp/crypto_collector.pid
    fi
    
    if [ -f /tmp/crypto_api.pid ]; then
        API_PID=$(cat /tmp/crypto_api.pid)
        if ps -p $API_PID > /dev/null 2>&1; then
            kill $API_PID
            log_success "API ä¼ºæœå™¨å·²åœæ­¢"
        fi
        rm /tmp/crypto_api.pid
    fi
}

# æª¢æŸ¥æœå‹™ç‹€æ…‹
check_status() {
    echo -e "\n${BLUE}========== æœå‹™ç‹€æ…‹ ==========${NC}"
    
    if [ -f /tmp/crypto_collector.pid ]; then
        COLLECTOR_PID=$(cat /tmp/crypto_collector.pid)
        if ps -p $COLLECTOR_PID > /dev/null 2>&1; then
            log_success "æ•¸æ“šæ”¶é›†å™¨é‹è¡Œä¸­ (PID: $COLLECTOR_PID)"
        else
            log_warning "æ•¸æ“šæ”¶é›†å™¨æœªé‹è¡Œ"
        fi
    else
        log_warning "æ•¸æ“šæ”¶é›†å™¨æœªé‹è¡Œ"
    fi
    
    if [ -f /tmp/crypto_api.pid ]; then
        API_PID=$(cat /tmp/crypto_api.pid)
        if ps -p $API_PID > /dev/null 2>&1; then
            log_success "API ä¼ºæœå™¨é‹è¡Œä¸­ (PID: $API_PID)"
        else
            log_warning "API ä¼ºæœå™¨æœªé‹è¡Œ"
        fi
    else
        log_warning "API ä¼ºæœå™¨æœªé‹è¡Œ"
    fi
    
    echo -e "${BLUE}==============================${NC}\n"
}

# åŸ·è¡Œ Log åˆ†æ
run_analysis() {
    log_info "åŸ·è¡Œ Log åˆ†æ..."
    cd "$PROJECT_DIR"
    python3 scripts/analyze_logs.py
    log_success "Log åˆ†æå®Œæˆ"
}

# ä¸»é¸å–®
show_menu() {
    echo -e "\n${GREEN}========================================${NC}"
    echo -e "${GREEN}   åŠ å¯†è²¨å¹£ç›£æ§ç³»çµ± - æ§åˆ¶é¢æ¿${NC}"
    echo -e "${GREEN}========================================${NC}"
    echo "1. ğŸ”§ å®‰è£ä¾è³´å¥—ä»¶"
    echo "2. ğŸ—„ï¸  åˆå§‹åŒ–è³‡æ–™åº«"
    echo "3. ğŸš€ å•Ÿå‹•æ‰€æœ‰æœå‹™"
    echo "4. â¹ï¸  åœæ­¢æ‰€æœ‰æœå‹™"
    echo "5. ğŸ“Š åŸ·è¡Œ Log åˆ†æ"
    echo "6. ğŸ” æª¢æŸ¥æœå‹™ç‹€æ…‹"
    echo "7. ğŸ“– æŸ¥çœ‹æ—¥èªŒ"
    echo "8. ğŸŒ é–‹å•Ÿå‰ç«¯ç¶²ç«™"
    echo "0. âŒ é€€å‡º"
    echo -e "${GREEN}========================================${NC}"
}

# æŸ¥çœ‹æ—¥èªŒ
view_logs() {
    echo -e "\n${BLUE}é¸æ“‡è¦æŸ¥çœ‹çš„æ—¥èªŒ:${NC}"
    echo "1. FR & OB æ—¥èªŒ"
    echo "2. Options æ—¥èªŒ"
    echo "3. ç³»çµ±æ—¥èªŒ"
    echo "0. è¿”å›"
    
    read -p "è«‹é¸æ“‡ [0-3]: " log_choice
    
    case $log_choice in
        1)
            tail -f "$PROJECT_DIR/logs/fr_ob_metrics.log"
            ;;
        2)
            tail -f "$PROJECT_DIR/logs/options_metrics.log"
            ;;
        3)
            tail -f "$PROJECT_DIR/logs/system.log"
            ;;
        0)
            return
            ;;
        *)
            log_error "ç„¡æ•ˆçš„é¸æ“‡"
            ;;
    esac
}

# é–‹å•Ÿå‰ç«¯ç¶²ç«™
open_frontend() {
    log_info "é–‹å•Ÿå‰ç«¯ç¶²ç«™..."
    
    if command -v xdg-open &> /dev/null; then
        xdg-open "http://localhost:8000/static/index.html"
    elif command -v open &> /dev/null; then
        open "http://localhost:8000/static/index.html"
    else
        log_info "è«‹åœ¨ç€è¦½å™¨é–‹å•Ÿ: http://localhost:8000/static/index.html"
    fi
}

# ä¸»ç¨‹å¼
main() {
    # æª¢æŸ¥ç’°å¢ƒ
    check_python
    check_postgresql
    
    while true; do
        show_menu
        read -p "è«‹é¸æ“‡æ“ä½œ [0-8]: " choice
        
        case $choice in
            1)
                install_packages
                ;;
            2)
                init_database
                ;;
            3)
                start_collector
                sleep 2
                start_api
                sleep 2
                check_status
                log_info "å‰ç«¯ç¶²å€: http://localhost:8000/static/index.html"
                log_info "API æ–‡æª”: http://localhost:8000/docs"
                ;;
            4)
                stop_services
                ;;
            5)
                run_analysis
                ;;
            6)
                check_status
                ;;
            7)
                view_logs
                ;;
            8)
                open_frontend
                ;;
            0)
                log_info "é€€å‡ºç¨‹å¼"
                exit 0
                ;;
            *)
                log_error "ç„¡æ•ˆçš„é¸æ“‡ï¼Œè«‹é‡æ–°è¼¸å…¥"
                ;;
        esac
        
        echo ""
        read -p "æŒ‰ Enter ç¹¼çºŒ..."
    done
}

# åŸ·è¡Œä¸»ç¨‹å¼
main

"""
è³‡æ–™åº«åˆå§‹åŒ–èˆ‡ç®¡ç†è…³æœ¬
- å»ºç«‹è³‡æ–™åº«çµæ§‹
- æ™‚é–“åˆ†ç‰‡ç®¡ç†
- æ¸…ç†èˆŠæ•¸æ“š
"""
import psycopg2
from datetime import datetime, timedelta
import sys

DB_CONFIG = {
    "host": "localhost",
    "port": 5432,
    "database": "crypto_metrics",
    "user": "postgres",
    "password": "your_password"
}

def create_database():
    """å»ºç«‹è³‡æ–™åº«"""
    conn = psycopg2.connect(
        host=DB_CONFIG["host"],
        port=DB_CONFIG["port"],
        database="postgres",
        user=DB_CONFIG["user"],
        password=DB_CONFIG["password"]
    )
    conn.autocommit = True
    cursor = conn.cursor()
    
    try:
        cursor.execute(f"CREATE DATABASE {DB_CONFIG['database']}")
        print(f"âœ… è³‡æ–™åº« {DB_CONFIG['database']} å»ºç«‹æˆåŠŸ")
    except psycopg2.errors.DuplicateDatabase:
        print(f"â„¹ï¸  è³‡æ–™åº« {DB_CONFIG['database']} å·²å­˜åœ¨")
    
    cursor.close()
    conn.close()

def init_tables():
    """åˆå§‹åŒ–è¡¨çµæ§‹"""
    conn = psycopg2.connect(**DB_CONFIG)
    cursor = conn.cursor()
    
    # 1. Options Greeks æ¨¡æ¿è¡¨ï¼ˆç”¨æ–¼å»ºç«‹æ¯æ—¥åˆ†ç‰‡ï¼‰
    print("ğŸ“‹ å»ºç«‹ Options Greeks è¡¨çµæ§‹...")
    
    # é€™æ˜¯ä¸€å€‹ç¯„ä¾‹è¡¨ï¼Œå¯¦éš›çš„è¡¨æœƒæŒ‰æ—¥æœŸå‹•æ…‹å»ºç«‹
    # ä¾‹å¦‚: options_greeks_20241212
    
    # 2. FR & OB å½™ç¸½è¡¨ï¼ˆå¾ Log åŒ¯å…¥çš„çµ±è¨ˆæ•¸æ“šï¼‰
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS funding_rate_stats (
            date DATE NOT NULL,
            exchange VARCHAR(50),
            symbol VARCHAR(100),
            period VARCHAR(20),  -- '14d' or '7d'
            max_fr NUMERIC(10,8),
            min_fr NUMERIC(10,8),
            avg_fr NUMERIC(10,8),
            std_fr NUMERIC(10,8),
            count INTEGER,
            updated_at TIMESTAMPTZ DEFAULT NOW(),
            PRIMARY KEY (date, exchange, symbol, period)
        );
        
        CREATE INDEX IF NOT EXISTS idx_fr_stats_date ON funding_rate_stats (date);
        CREATE INDEX IF NOT EXISTS idx_fr_stats_symbol ON funding_rate_stats (symbol);
    """)
    
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS orderbook_spread_stats (
            date DATE NOT NULL,
            exchange VARCHAR(50),
            symbol VARCHAR(100),
            period VARCHAR(20),  -- '14d' or '7d'
            max_spread NUMERIC(20,8),
            min_spread NUMERIC(20,8),
            avg_spread NUMERIC(20,8),
            max_spread_pct NUMERIC(10,6),
            min_spread_pct NUMERIC(10,6),
            avg_spread_pct NUMERIC(10,6),
            count INTEGER,
            updated_at TIMESTAMPTZ DEFAULT NOW(),
            PRIMARY KEY (date, exchange, symbol, period)
        );
        
        CREATE INDEX IF NOT EXISTS idx_ob_stats_date ON orderbook_spread_stats (date);
        CREATE INDEX IF NOT EXISTS idx_ob_stats_symbol ON orderbook_spread_stats (symbol);
    """)
    
    # 3. Options Greeks çµ±è¨ˆè¡¨
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS options_greeks_stats (
            date DATE NOT NULL,
            symbol VARCHAR(100),
            period VARCHAR(20),  -- '14d' or '7d'
            max_iv NUMERIC(10,6),
            min_iv NUMERIC(10,6),
            avg_iv NUMERIC(10,6),
            max_delta NUMERIC(10,6),
            min_delta NUMERIC(10,6),
            avg_delta NUMERIC(10,6),
            max_gamma NUMERIC(10,6),
            min_gamma NUMERIC(10,6),
            avg_gamma NUMERIC(10,6),
            max_vega NUMERIC(10,6),
            min_vega NUMERIC(10,6),
            avg_vega NUMERIC(10,6),
            max_theta NUMERIC(10,6),
            min_theta NUMERIC(10,6),
            avg_theta NUMERIC(10,6),
            count INTEGER,
            updated_at TIMESTAMPTZ DEFAULT NOW(),
            PRIMARY KEY (date, symbol, period)
        );
        
        CREATE INDEX IF NOT EXISTS idx_options_stats_date ON options_greeks_stats (date);
        CREATE INDEX IF NOT EXISTS idx_options_stats_symbol ON options_greeks_stats (symbol);
    """)
    
    conn.commit()
    print("âœ… æ‰€æœ‰è¡¨çµæ§‹å»ºç«‹å®Œæˆ")
    
    cursor.close()
    conn.close()

def create_daily_options_table(date_str: str):
    """å»ºç«‹æ¯æ—¥ Options Greeks åˆ†ç‰‡è¡¨"""
    conn = psycopg2.connect(**DB_CONFIG)
    cursor = conn.cursor()
    
    table_name = f"options_greeks_{date_str}"
    
    cursor.execute(f"""
        CREATE TABLE IF NOT EXISTS {table_name} (
            ts_ms BIGINT NOT NULL,
            ts TIMESTAMPTZ NOT NULL,
            exchange VARCHAR(50),
            symbol VARCHAR(100),
            price NUMERIC(20,8),
            mark_price NUMERIC(20,8),
            index_price NUMERIC(20,8),
            underlying_price NUMERIC(20,8),
            iv NUMERIC(10,6),
            delta NUMERIC(10,6),
            gamma NUMERIC(10,6),
            vega NUMERIC(10,6),
            theta NUMERIC(10,6),
            rho NUMERIC(10,6),
            volume_24h NUMERIC(20,8),
            open_interest NUMERIC(20,8),
            raw_data JSONB,
            PRIMARY KEY (ts_ms, exchange, symbol)
        );
        
        CREATE INDEX IF NOT EXISTS idx_{table_name}_ts ON {table_name} (ts);
        CREATE INDEX IF NOT EXISTS idx_{table_name}_symbol ON {table_name} (symbol);
        CREATE INDEX IF NOT EXISTS idx_{table_name}_iv ON {table_name} (iv);
    """)
    
    conn.commit()
    print(f"âœ… å»ºç«‹è¡¨: {table_name}")
    
    cursor.close()
    conn.close()

def cleanup_old_tables(days_to_keep=30):
    """æ¸…ç†èˆŠçš„åˆ†ç‰‡è¡¨"""
    conn = psycopg2.connect(**DB_CONFIG)
    cursor = conn.cursor()
    
    cutoff_date = datetime.now() - timedelta(days=days_to_keep)
    
    # å–å¾—æ‰€æœ‰ options_greeks_ é–‹é ­çš„è¡¨
    cursor.execute("""
        SELECT tablename FROM pg_tables 
        WHERE schemaname = 'public' 
        AND tablename LIKE 'options_greeks_%'
    """)
    
    tables = cursor.fetchall()
    
    for (table_name,) in tables:
        # å¾è¡¨åè§£ææ—¥æœŸ
        try:
            date_part = table_name.replace('options_greeks_', '')
            table_date = datetime.strptime(date_part, '%Y%m%d')
            
            if table_date < cutoff_date:
                cursor.execute(f"DROP TABLE {table_name}")
                print(f"ğŸ—‘ï¸  åˆªé™¤èˆŠè¡¨: {table_name}")
        except:
            continue
    
    conn.commit()
    cursor.close()
    conn.close()

def prepare_future_tables(days=7):
    """é å…ˆå»ºç«‹æœªä¾†å¹¾å¤©çš„è¡¨"""
    today = datetime.now()
    
    for i in range(days):
        date = today + timedelta(days=i)
        date_str = date.strftime('%Y%m%d')
        create_daily_options_table(date_str)

def main():
    """ä¸»ç¨‹å¼"""
    print("=" * 60)
    print("ğŸ”§ è³‡æ–™åº«åˆå§‹åŒ–èˆ‡ç®¡ç†")
    print("=" * 60)
    
    if len(sys.argv) > 1:
        command = sys.argv[1]
        
        if command == "init":
            print("\n1ï¸âƒ£ å»ºç«‹è³‡æ–™åº«...")
            create_database()
            
            print("\n2ï¸âƒ£ åˆå§‹åŒ–è¡¨çµæ§‹...")
            init_tables()
            
            print("\n3ï¸âƒ£ å»ºç«‹æœªä¾† 7 å¤©çš„åˆ†ç‰‡è¡¨...")
            prepare_future_tables(7)
            
            print("\nâœ… è³‡æ–™åº«åˆå§‹åŒ–å®Œæˆ")
        
        elif command == "cleanup":
            days = int(sys.argv[2]) if len(sys.argv) > 2 else 30
            print(f"\nğŸ—‘ï¸  æ¸…ç† {days} å¤©å‰çš„èˆŠè¡¨...")
            cleanup_old_tables(days)
            print("\nâœ… æ¸…ç†å®Œæˆ")
        
        elif command == "prepare":
            days = int(sys.argv[2]) if len(sys.argv) > 2 else 7
            print(f"\nğŸ“… å»ºç«‹æœªä¾† {days} å¤©çš„åˆ†ç‰‡è¡¨...")
            prepare_future_tables(days)
            print("\nâœ… å»ºç«‹å®Œæˆ")
        
        else:
            print("\nâŒ æœªçŸ¥å‘½ä»¤")
            print("å¯ç”¨å‘½ä»¤: init, cleanup, prepare")
    
    else:
        print("\nä½¿ç”¨æ–¹å¼:")
        print("  python db_init.py init         - åˆå§‹åŒ–è³‡æ–™åº«")
        print("  python db_init.py cleanup [å¤©æ•¸] - æ¸…ç†èˆŠè¡¨ï¼ˆé è¨­ 30 å¤©ï¼‰")
        print("  python db_init.py prepare [å¤©æ•¸] - å»ºç«‹æœªä¾†è¡¨ï¼ˆé è¨­ 7 å¤©ï¼‰")

if __name__ == "__main__":
    main()

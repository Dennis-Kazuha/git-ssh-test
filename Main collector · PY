"""
åŠ å¯†è²¨å¹£æ•¸æ“šæ”¶é›†å™¨
- Options Greeks: æ¯«ç§’ç´šï¼Œç›´æ¥å¯«å…¥è³‡æ–™åº«
- Funding Rate & Order Book: Log æ–¹å¼è¨˜éŒ„
"""
import ccxt
import json
import logging
import time
import asyncio
from datetime import datetime, timezone
from pathlib import Path
from typing import Dict, List
import psycopg2
from psycopg2.extras import execute_values
from threading import Thread

# ==================== é…ç½® ====================
# äº¤æ˜“æ‰€èˆ‡äº¤æ˜“å°
EXCHANGES = ["mexc", "binance", "deribit"]
SPOT_SYMBOLS = ["BTC/USDT", "ETH/USDT"]
OPTIONS_SYMBOLS = [
    "BTC-30JAN26-90000-C",
    "BTC-30JAN26-90000-P",
    "BTC-USDC-30JAN26-90000-C",  # æ ¹æ“šä½ çš„æˆªåœ–
]

# æ”¶é›†é–“éš”
FR_OB_INTERVAL = 5  # FR å’Œ OB æ¯ 5 ç§’
OPTIONS_INTERVAL_MS = 100  # Options æ¯ 100 æ¯«ç§’

# è³‡æ–™åº«é€£ç·š
DB_CONFIG = {
    "host": "localhost",
    "port": 5432,
    "database": "crypto_metrics",
    "user": "postgres",
    "password": "your_password"
}

# Log è¨­å®š
BASE_DIR = Path(__file__).resolve().parent.parent
LOG_DIR = BASE_DIR / "logs"
LOG_DIR.mkdir(exist_ok=True)

# ==================== Logger è¨­å®š ====================
# FR & OB Logger
fr_ob_logger = logging.getLogger("fr_ob_collector")
fr_ob_logger.setLevel(logging.INFO)
fr_ob_handler = logging.FileHandler(LOG_DIR / "fr_ob_metrics.log", encoding="utf-8")
fr_ob_handler.setFormatter(logging.Formatter("%(message)s"))
fr_ob_logger.addHandler(fr_ob_handler)

# Options Logger (å‚™ç”¨)
options_logger = logging.getLogger("options_collector")
options_logger.setLevel(logging.INFO)
options_handler = logging.FileHandler(LOG_DIR / "options_metrics.log", encoding="utf-8")
options_handler.setFormatter(logging.Formatter("%(message)s"))
options_logger.addHandler(options_handler)

# System Logger
sys_logger = logging.getLogger("system")
sys_logger.setLevel(logging.INFO)
sys_handler = logging.FileHandler(LOG_DIR / "system.log", encoding="utf-8")
sys_handler.setFormatter(logging.Formatter("%(asctime)s - %(levelname)s - %(message)s"))
sys_logger.addHandler(sys_handler)

# ==================== äº¤æ˜“æ‰€ç®¡ç† ====================
EXCHANGE_OBJS = {}

def get_exchange(ex_id: str):
    """å–å¾—æˆ–å»ºç«‹äº¤æ˜“æ‰€ç‰©ä»¶"""
    if ex_id in EXCHANGE_OBJS:
        return EXCHANGE_OBJS[ex_id]
    
    ex_class = getattr(ccxt, ex_id)
    config = {"enableRateLimit": True}
    
    # Deribit éœ€è¦é¡å¤–è¨­å®š
    if ex_id == "deribit":
        config["options"] = {"defaultType": "option"}
    
    ex = ex_class(config)
    EXCHANGE_OBJS[ex_id] = ex
    return ex

# ==================== æ™‚é–“æˆ³è¨˜ ====================
def now_ts():
    """å›å‚³ ISO8601 å­—ä¸²å’Œæ¯«ç§’æ™‚é–“æˆ³"""
    now = datetime.now(timezone.utc)
    ts_ms = int(now.timestamp() * 1000)
    # åŒ…å«æ¯«ç§’çš„ ISO æ ¼å¼
    iso_with_ms = now.strftime('%Y-%m-%dT%H:%M:%S.%f')[:-3] + 'Z'
    return iso_with_ms, ts_ms

# ==================== è³‡æ–™åº«æ“ä½œ ====================
class DatabaseManager:
    def __init__(self, config):
        self.config = config
        self.conn = None
        self.cursor = None
        self.connect()
    
    def connect(self):
        """å»ºç«‹è³‡æ–™åº«é€£ç·š"""
        try:
            self.conn = psycopg2.connect(**self.config)
            self.cursor = self.conn.cursor()
            sys_logger.info("è³‡æ–™åº«é€£ç·šæˆåŠŸ")
        except Exception as e:
            sys_logger.error(f"è³‡æ–™åº«é€£ç·šå¤±æ•—: {e}")
            self.conn = None
    
    def insert_options_greeks(self, records: List[Dict]):
        """æ‰¹æ¬¡æ’å…¥ Options Greeks æ•¸æ“š"""
        if not self.conn or not records:
            return
        
        try:
            # å–å¾—ç•¶å‰æ—¥æœŸä½œç‚ºè¡¨åå¾Œç¶´
            date_suffix = datetime.now(timezone.utc).strftime('%Y%m%d')
            table_name = f"options_greeks_{date_suffix}"
            
            # ç¢ºä¿è¡¨å­˜åœ¨
            self.ensure_table_exists(table_name)
            
            # æº–å‚™æ’å…¥æ•¸æ“š
            values = []
            for r in records:
                values.append((
                    r['ts_ms'],
                    r['ts'],
                    r['exchange'],
                    r['symbol'],
                    r.get('price'),
                    r.get('iv'),
                    r.get('delta'),
                    r.get('gamma'),
                    r.get('vega'),
                    r.get('theta'),
                    r.get('rho'),
                    json.dumps(r)  # å„²å­˜å®Œæ•´ JSON ä»¥å‚™ä¸æ™‚ä¹‹éœ€
                ))
            
            query = f"""
                INSERT INTO {table_name} 
                (ts_ms, ts, exchange, symbol, price, iv, delta, gamma, vega, theta, rho, raw_data)
                VALUES %s
            """
            
            execute_values(self.cursor, query, values)
            self.conn.commit()
            
        except Exception as e:
            sys_logger.error(f"æ’å…¥ Options Greeks å¤±æ•—: {e}")
            self.conn.rollback()
    
    def ensure_table_exists(self, table_name: str):
        """ç¢ºä¿æ—¥æœŸåˆ†ç‰‡è¡¨å­˜åœ¨"""
        try:
            create_query = f"""
                CREATE TABLE IF NOT EXISTS {table_name} (
                    ts_ms BIGINT NOT NULL,
                    ts TIMESTAMPTZ NOT NULL,
                    exchange VARCHAR(50),
                    symbol VARCHAR(100),
                    price NUMERIC(20,8),
                    iv NUMERIC(10,6),
                    delta NUMERIC(10,6),
                    gamma NUMERIC(10,6),
                    vega NUMERIC(10,6),
                    theta NUMERIC(10,6),
                    rho NUMERIC(10,6),
                    raw_data JSONB,
                    PRIMARY KEY (ts_ms, exchange, symbol)
                );
                
                CREATE INDEX IF NOT EXISTS idx_{table_name}_ts ON {table_name} (ts);
                CREATE INDEX IF NOT EXISTS idx_{table_name}_symbol ON {table_name} (symbol);
            """
            self.cursor.execute(create_query)
            self.conn.commit()
        except Exception as e:
            sys_logger.error(f"å»ºç«‹è¡¨ {table_name} å¤±æ•—: {e}")
    
    def close(self):
        """é—œé–‰è³‡æ–™åº«é€£ç·š"""
        if self.cursor:
            self.cursor.close()
        if self.conn:
            self.conn.close()

# ==================== Funding Rate æ”¶é›† ====================
def collect_funding_rate(ex_id: str, symbol: str):
    """æ”¶é›† Funding Rate ä¸¦è¨˜éŒ„åˆ° Log"""
    ex = get_exchange(ex_id)
    
    try:
        fr = ex.fetch_funding_rate(symbol)
    except Exception as e:
        sys_logger.warning(f"[FR] {ex_id} {symbol} æŠ“å–å¤±æ•—: {e}")
        return
    
    if not fr or "fundingRate" not in fr:
        sys_logger.warning(f"[FR] {ex_id} {symbol} è³‡æ–™ä¸å®Œæ•´")
        return
    
    iso, ts_ms = now_ts()
    
    record = {
        "ts": iso,
        "ts_ms": ts_ms,
        "exchange": ex_id,
        "symbol": symbol,
        "metric": "funding_rate",
        "tag": "FR",  # æ–¹ä¾¿å¾ŒçºŒåˆ†æ
        "funding_rate": fr["fundingRate"],
        "funding_timestamp": fr.get("fundingTimestamp"),
        "next_funding_time": fr.get("fundingDatetime"),
    }
    
    fr_ob_logger.info(json.dumps(record, ensure_ascii=False))

# ==================== Order Book æ”¶é›† ====================
def collect_orderbook_spread(ex_id: str, symbol: str):
    """æ”¶é›† Order Book Spread ä¸¦è¨˜éŒ„åˆ° Log"""
    ex = get_exchange(ex_id)
    
    try:
        ob = ex.fetch_order_book(symbol, limit=5)
    except Exception as e:
        sys_logger.warning(f"[OB] {ex_id} {symbol} æŠ“å–å¤±æ•—: {e}")
        return
    
    bids = ob.get("bids") or []
    asks = ob.get("asks") or []
    
    if not bids or not asks:
        sys_logger.warning(f"[OB] {ex_id} {symbol} æ²’æœ‰æ›å–®")
        return
    
    best_bid = bids[0][0]
    best_ask = asks[0][0]
    spread = best_ask - best_bid
    spread_pct = (spread / best_bid) * 100 if best_bid > 0 else 0
    
    # ç¬¬ä¸‰æª”
    bid3 = bids[2][0] if len(bids) >= 3 else None
    ask3 = asks[2][0] if len(asks) >= 3 else None
    
    iso, ts_ms = now_ts()
    
    record = {
        "ts": iso,
        "ts_ms": ts_ms,
        "exchange": ex_id,
        "symbol": symbol,
        "metric": "orderbook_spread",
        "tag": "OB",  # æ–¹ä¾¿å¾ŒçºŒåˆ†æ
        "best_bid": best_bid,
        "best_ask": best_ask,
        "spread": spread,
        "spread_pct": spread_pct,
        "bid3": bid3,
        "ask3": ask3,
        "bid_volume": bids[0][1],
        "ask_volume": asks[0][1],
    }
    
    fr_ob_logger.info(json.dumps(record, ensure_ascii=False))

# ==================== Options Greeks æ”¶é›† ====================
def collect_options_greeks(ex_id: str, symbol: str, db_manager: DatabaseManager):
    """æ”¶é›† Options Greeksï¼ˆæ¯«ç§’ç´šï¼‰"""
    ex = get_exchange(ex_id)
    
    try:
        # Deribit çš„ Greeks æ•¸æ“š
        ticker = ex.fetch_ticker(symbol)
        
        iso, ts_ms = now_ts()
        
        record = {
            "ts": iso,
            "ts_ms": ts_ms,
            "exchange": ex_id,
            "symbol": symbol,
            "metric": "options_greeks",
            "tag": "OPTIONS",
            # åƒ¹æ ¼ç›¸é—œ
            "price": ticker.get('last'),
            "mark_price": ticker.get('markPrice'),
            "index_price": ticker.get('indexPrice'),
            "underlying_price": ticker.get('underlyingPrice'),
            # Greeks
            "iv": ticker.get('impliedVolatility') or ticker.get('info', {}).get('mark_iv'),
            "delta": ticker.get('info', {}).get('greeks', {}).get('delta'),
            "gamma": ticker.get('info', {}).get('greeks', {}).get('gamma'),
            "vega": ticker.get('info', {}).get('greeks', {}).get('vega'),
            "theta": ticker.get('info', {}).get('greeks', {}).get('theta'),
            "rho": ticker.get('info', {}).get('greeks', {}).get('rho'),
            # å…¶ä»–
            "volume_24h": ticker.get('quoteVolume'),
            "open_interest": ticker.get('info', {}).get('open_interest'),
        }
        
        # å¯«å…¥è³‡æ–™åº«
        if db_manager:
            db_manager.insert_options_greeks([record])
        
        # ä¹Ÿå¯«ä¸€ä»½åˆ° log ä»¥å‚™ä»½
        options_logger.info(json.dumps(record, ensure_ascii=False))
        
    except Exception as e:
        sys_logger.warning(f"[OPTIONS] {ex_id} {symbol} æŠ“å–å¤±æ•—: {e}")

# ==================== FR & OB æ”¶é›†åŸ·è¡Œç·’ ====================
def fr_ob_collector_thread():
    """FR å’Œ OB æ”¶é›†åŸ·è¡Œç·’ï¼ˆæ¯ 5 ç§’ï¼‰"""
    sys_logger.info("FR & OB æ”¶é›†å™¨å•Ÿå‹•")
    
    while True:
        start = time.time()
        
        for ex_id in ["mexc", "binance"]:
            for symbol in SPOT_SYMBOLS:
                # Funding Rate
                collect_funding_rate(ex_id, symbol)
                # Order Book
                collect_orderbook_spread(ex_id, symbol)
                time.sleep(0.5)  # é¿å… API rate limit
        
        elapsed = time.time() - start
        sleep_sec = max(0, FR_OB_INTERVAL - elapsed)
        if sleep_sec > 0:
            time.sleep(sleep_sec)

# ==================== Options æ”¶é›†åŸ·è¡Œç·’ ====================
def options_collector_thread(db_manager: DatabaseManager):
    """Options Greeks æ”¶é›†åŸ·è¡Œç·’ï¼ˆæ¯«ç§’ç´šï¼‰"""
    sys_logger.info("Options Greeks æ”¶é›†å™¨å•Ÿå‹•ï¼ˆæ¯«ç§’ç´šï¼‰")
    
    while True:
        start_ms = time.time() * 1000
        
        for symbol in OPTIONS_SYMBOLS:
            collect_options_greeks("deribit", symbol, db_manager)
        
        elapsed_ms = (time.time() * 1000) - start_ms
        sleep_ms = max(0, OPTIONS_INTERVAL_MS - elapsed_ms)
        if sleep_ms > 0:
            time.sleep(sleep_ms / 1000)

# ==================== ä¸»ç¨‹å¼ ====================
def main():
    """ä¸»ç¨‹å¼å…¥å£"""
    print("=" * 60)
    print("ğŸš€ åŠ å¯†è²¨å¹£æ•¸æ“šæ”¶é›†ç³»çµ±å•Ÿå‹•")
    print("=" * 60)
    print(f"ğŸ“ Log ç›®éŒ„: {LOG_DIR}")
    print(f"ğŸ“Š Options é–“éš”: {OPTIONS_INTERVAL_MS} ms")
    print(f"ğŸ“Š FR/OB é–“éš”: {FR_OB_INTERVAL} ç§’")
    print("=" * 60)
    
    sys_logger.info("ç³»çµ±å•Ÿå‹•")
    
    # åˆå§‹åŒ–è³‡æ–™åº«
    db_manager = DatabaseManager(DB_CONFIG)
    
    # å•Ÿå‹• FR & OB æ”¶é›†åŸ·è¡Œç·’
    fr_ob_thread = Thread(target=fr_ob_collector_thread, daemon=True)
    fr_ob_thread.start()
    
    # å•Ÿå‹• Options æ”¶é›†åŸ·è¡Œç·’
    options_thread = Thread(target=lambda: options_collector_thread(db_manager), daemon=True)
    options_thread.start()
    
    print("âœ… æ‰€æœ‰æ”¶é›†å™¨å·²å•Ÿå‹•")
    print("æŒ‰ Ctrl+C åœæ­¢...")
    
    try:
        while True:
            time.sleep(1)
    except KeyboardInterrupt:
        print("\nâ¹ï¸  æ”¶é›†å™¨åœæ­¢ä¸­...")
        sys_logger.info("ç³»çµ±åœæ­¢")
        db_manager.close()
        print("âœ… å·²åœæ­¢")

if __name__ == "__main__":
    main()
